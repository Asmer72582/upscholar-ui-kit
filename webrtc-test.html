<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Diagnostic Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .pass { background-color: #d4edda; border-color: #c3e6cb; }
        .fail { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeeba; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        video { width: 300px; height: 200px; border: 1px solid #ccc; margin: 10px; }
    </style>
</head>
<body>
    <h1>üß™ WebRTC Diagnostic Test</h1>
    <p>This page tests if your browser can access camera/microphone for WebRTC</p>

    <div class="test" id="https-test">
        <h3>1. HTTPS Protocol Test</h3>
        <div id="https-result"></div>
    </div>

    <div class="test" id="webrtc-test">
        <h3>2. WebRTC API Test</h3>
        <div id="webrtc-result"></div>
    </div>

    <div class="test" id="media-test">
        <h3>3. Media Devices Test</h3>
        <button onclick="testMediaDevices()">Test Camera & Microphone</button>
        <div id="media-result"></div>
        <div id="video-container"></div>
    </div>

    <div class="test" id="permission-test">
        <h3>4. Permission Test</h3>
        <button onclick="testPermissions()">Request Media Permissions</button>
        <div id="permission-result"></div>
    </div>

    <script>
        // Test 1: HTTPS Protocol
        function testHTTPS() {
            const result = document.getElementById('https-result');
            if (location.protocol === 'https:') {
                result.innerHTML = '<span style="color: green;">‚úÖ HTTPS is enabled - WebRTC should work</span>';
                document.getElementById('https-test').className = 'test pass';
            } else {
                result.innerHTML = '<span style="color: red;">‚ùå HTTP detected - WebRTC will be blocked in production</span>';
                document.getElementById('https-test').className = 'test fail';
            }
        }

        // Test 2: WebRTC API Support
        function testWebRTC() {
            const result = document.getElementById('webrtc-result');
            const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            const hasRTCPeerConnection = !!(window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection);
            
            let html = '';
            if (hasGetUserMedia) {
                html += '<span style="color: green;">‚úÖ getUserMedia API supported</span><br>';
            } else {
                html += '<span style="color: red;">‚ùå getUserMedia API not supported</span><br>';
            }
            
            if (hasRTCPeerConnection) {
                html += '<span style="color: green;">‚úÖ RTCPeerConnection API supported</span><br>';
            } else {
                html += '<span style="color: red;">‚ùå RTCPeerConnection API not supported</span><br>';
            }
            
            result.innerHTML = html;
            document.getElementById('webrtc-test').className = (hasGetUserMedia && hasRTCPeerConnection) ? 'test pass' : 'test fail';
        }

        // Test 3: Media Devices
        async function testMediaDevices() {
            const result = document.getElementById('media-result');
            const videoContainer = document.getElementById('video-container');
            
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                const audioDevices = devices.filter(d => d.kind === 'audioinput');
                
                let html = `<span style="color: green;">‚úÖ Found ${videoDevices.length} cameras and ${audioDevices.length} microphones</span><br>`;
                
                videoDevices.forEach((device, i) => {
                    html += `Camera ${i+1}: ${device.label || 'Unknown'}<br>`;
                });
                
                audioDevices.forEach((device, i) => {
                    html += `Microphone ${i+1}: ${device.label || 'Unknown'}<br>`;
                });
                
                result.innerHTML = html;
                document.getElementById('media-test').className = 'test pass';
                
                // Test actual media access
                testActualMediaAccess(videoContainer);
                
            } catch (error) {
                result.innerHTML = `<span style="color: red;">‚ùå Error accessing media devices: ${error.message}</span>`;
                document.getElementById('media-test').className = 'test fail';
            }
        }

        // Test actual media access
        async function testActualMediaAccess(container) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                const video = document.createElement('video');
                video.srcObject = stream;
                video.autoplay = true;
                video.muted = true;
                container.appendChild(video);
                
                const result = document.getElementById('media-result');
                result.innerHTML += '<br><span style="color: green;">‚úÖ Successfully accessed camera and microphone!</span>';
                
                // Stop the stream after 5 seconds
                setTimeout(() => {
                    stream.getTracks().forEach(track => track.stop());
                    video.remove();
                }, 5000);
                
            } catch (error) {
                const result = document.getElementById('media-result');
                result.innerHTML += `<br><span style="color: red;">‚ùå Media access failed: ${error.message}</span>`;
                
                if (error.name === 'NotAllowedError') {
                    result.innerHTML += '<br><span style="color: orange;">‚ö†Ô∏è Permission denied - check browser settings</span>';
                } else if (error.name === 'NotFoundError') {
                    result.innerHTML += '<br><span style="color: orange;">‚ö†Ô∏è No media devices found</span>';
                } else if (error.name === 'NotReadableError') {
                    result.innerHTML += '<br><span style="color: orange;">‚ö†Ô∏è Media device is already in use</span>';
                }
            }
        }

        // Test permissions
        async function testPermissions() {
            const result = document.getElementById('permission-result');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                result.innerHTML = '<span style="color: green;">‚úÖ Media permissions granted successfully!</span>';
                document.getElementById('permission-test').className = 'test pass';
                
                // Stop the stream
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                result.innerHTML = `<span style="color: red;">‚ùå Permission test failed: ${error.message}</span>`;
                document.getElementById('permission-test').className = 'test fail';
                
                if (error.name === 'NotAllowedError') {
                    result.innerHTML += '<br><span style="color: orange;">üí° Tip: Check your browser settings and allow camera/microphone access</span>';
                }
            }
        }

        // Run initial tests
        window.onload = function() {
            testHTTPS();
            testWebRTC();
        };
    </script>
</body>
</html>